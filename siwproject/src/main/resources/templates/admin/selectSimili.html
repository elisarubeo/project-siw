<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
  <meta charset="UTF-8">
  <title th:text="'Aggiungi prodotti simili a ' + ${prodotto.nome}">Aggiungi simili</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" th:href="@{/}">MyCatalog</a>
  </div>
</nav>

<div class="container" style="max-width: 900px;">
  <div class="card shadow-sm">
    <div class="card-header">
      <h4 class="mb-0" th:text="'Aggiungi prodotti simili a: ' + ${prodotto.nome}">Aggiungi prodotti simili</h4>
    </div>

    <div class="card-body">

      <!-- Search client-side -->
      <div class="mb-3">
        <label class="form-label">Cerca prodotto</label>
        <input id="filterInput" type="text" class="form-control" placeholder="Digita per filtrare…">
      </div>

      <form th:action="@{'/admin/prodotto/' + ${prodotto.id} + '/simili/add-bulk'}" method="post">
        <!-- CSRF (se attivo in Security) -->
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div th:if="${#lists.isEmpty(candidatiSimili)}" class="alert alert-info">
          Non ci sono prodotti candidati: sono già tutti simili oppure è l’unico prodotto disponibile.
        </div>

        <div class="row g-3" id="cardsContainer" th:if="${!#lists.isEmpty(candidatiSimili)}">
          <div class="col-md-4 candidate"
               th:each="p : ${candidatiSimili}"
               th:attr="data-name=${#strings.toLowerCase(p.nome)}">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <h6 class="card-title mb-1" th:text="${p.nome}">Nome</h6>
                <div class="text-muted mb-2">€ <span th:text="${p.prezzo}">0.00</span></div>
                <p class="card-text small text-truncate"
                   style="-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;"
                   th:text="${p.descrizione}">Descrizione…</p>

                <div class="form-check mt-auto">
                  <input class="form-check-input"
                         type="checkbox"
                         name="targetIds"
                         th:id="|p_${p.id}|"
                         th:value="${p.id}">
                  <label class="form-check-label" th:for="|p_${p.id}|">Seleziona</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary" th:disabled="${#lists.isEmpty(candidatiSimili)}">
            Aggiungi selezionati
          </button>
          <a th:href="@{'/admin/formUpdateProdotto/' + ${prodotto.id}}" class="btn btn-outline-secondary">Annulla</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Filtro client-side per nome
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('filterInput');
    const cards = document.querySelectorAll('.candidate');
    input.addEventListener('input', function () {
      const q = input.value.trim().toLowerCase();
      cards.forEach(c => {
        const name = c.getAttribute('data-name') || '';
        c.style.display = name.includes(q) ? '' : 'none';
      });
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
